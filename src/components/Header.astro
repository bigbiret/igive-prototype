---
const { pathname } = Astro.url;
const base = import.meta.env.BASE_URL;

// Helper function to get correct path with base
function getPath(path: string) {
  if (path === '/') {
    return base;
  }
  return `${base}${path.startsWith('/') ? path.slice(1) : path}`;
}

// Define menu structure with routes
const menuStructure = {
  'gavekort': {
    routes: ['/', '/tjenester/digitale-gavekort', '/tjenester/digitale-gavekort-les-mer', '/tjenester/pos-integrert-les-mer', '/tjenester/wallet-gavekort', '/tjenester/fysiske-gavekort', '/tjenester/fysiske-gavekort-les-mer'],
    label: 'Gavekortløsninger'
  },
  'partner': {
    routes: ['/program'],
    label: 'Partnersider'
  },
  'kontakt': {
    routes: ['/informasjon-til-butikker', '/support', '/ofte-stilte-sporsmal', '/om-oss'],
    label: 'Kontakt oss'
  }
};

// Function to check if current path matches any route in a menu
function isMenuActive(menuRoutes: string[]) {
  return menuRoutes.some(route => 
    pathname === route || 
    pathname.startsWith(route + '/') ||
    (route === '/program' && pathname.startsWith('/program/'))
  );
}

// Function to check if a specific route is current
function isRouteActive(route: string) {
  return pathname === route || 
         pathname.startsWith(route + '/') ||
         (route === '/program' && pathname.startsWith('/program/'));
}

const activeMenu = Object.keys(menuStructure).find(key => 
  isMenuActive(menuStructure[key as keyof typeof menuStructure].routes)
);
---

<header class="sticky top-0 z-50 bg-igive-background border-b border-gray-200">
  <div class="container mx-auto px-6 py-4">
    <nav class="flex items-center justify-between">
      <!-- Logo -->
      <div class="flex items-center gap-2">
        <a href={getPath('/')} aria-label="iGive" class="flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 76 26" height="25" width="75" class="text-igive-text" aria-hidden="true" focusable="false">
            <path d="M7.44305 8.52066C4.96203 8.52066 2.48102 8.63622 0 8.71784C0 8.8223 0.203052 10.67 0.310127 11.5305C0.681627 11.5423 0.900348 11.5449 1.13082 11.5508C2.47884 11.5852 3.15372 12.2938 3.15546 13.6766C3.15546 14.0932 3.15546 14.5104 3.15546 14.9269C3.15546 18.1888 3.15546 21.3932 3.15546 24.7008H8.37931C8.37931 19.5507 8.39824 14.5659 8.33883 9.52417C8.33491 9.1703 8.18932 8.52066 7.44305 8.52066Z" fill="currentColor"/>
            <path d="M54.7214 8.67737C53.951 8.67737 53.6898 9.16835 53.5207 9.72331C52.5949 12.7613 51.1605 16.5272 50.0656 19.8857C49.7691 19.0689 47.3051 12.2239 46.41 9.67826C46.2618 9.25649 46.0542 8.6741 45.3516 8.6741C43.7481 8.6741 42.8478 8.67737 40.9805 8.67737C43.0776 14.0005 45.0846 19.462 47.1373 24.6466H52.7431C54.8017 19.6493 56.8466 13.9384 58.9097 8.67737H54.7214Z" fill="currentColor"/>
            <path d="M34 24.6368H39.0789V8.68063H34V24.6368Z" fill="currentColor"/>
            <path d="M75.8262 17.7351C75.881 17.3394 75.9117 16.9353 75.9117 16.5246C75.9117 15.8129 75.8249 15.1222 75.6643 14.4601C74.7365 10.6302 71.2879 7.78552 67.1726 7.78552C62.3458 7.78552 58.4336 11.6983 58.4336 16.5246C58.4336 19.9876 60.4484 22.9804 63.3695 24.3946C64.5193 24.9515 65.8094 25.2636 67.1733 25.2636C68.5372 25.2636 69.8267 24.9509 70.9771 24.3946C72.3887 23.711 73.588 22.6586 74.4512 21.3626L71.1227 19.2034C70.2197 20.4146 68.7807 21.2019 67.1544 21.2019C64.9371 21.2019 63.0607 19.744 62.4293 17.7351H75.8275H75.8262ZM62.539 14.4601C63.2572 12.6104 65.0494 11.2968 67.1531 11.2968C69.2567 11.2968 71.0489 12.6104 71.7671 14.4601H62.539Z" fill="currentColor"/>
            <path d="M7.62876 6.10075C8.70525 5.02425 8.70525 3.27891 7.62876 2.20241C6.55226 1.12592 4.80691 1.12592 3.73042 2.20241C2.65392 3.27891 2.65392 5.02425 3.73042 6.10075C4.80691 7.17725 6.55226 7.17725 7.62876 6.10075Z" fill="currentColor"/>
            <path d="M38.4881 6.15797C39.5646 5.08147 39.5646 3.33613 38.4881 2.25963C37.4116 1.18314 35.6663 1.18314 34.5898 2.25963C33.5133 3.33613 33.5133 5.08147 34.5898 6.15797C35.6663 7.23447 37.4116 7.23446 38.4881 6.15797Z" fill="currentColor"/>
            <path d="M30.1239 11.5651H27.0984L22.6469 16.2118H27.0984V19.6493C25.9767 20.3695 24.6441 20.7893 23.2117 20.7893C19.2342 20.7893 16.0096 17.5646 16.0096 13.5872C16.0096 9.60972 19.2342 6.38505 23.2117 6.38505C25.1639 6.38505 26.9326 7.16265 28.2299 8.4234L28.2286 8.42013L31.6132 4.8429C29.4299 2.74448 26.4657 1.45239 23.198 1.45239C16.4894 1.45239 11.0508 6.89104 11.0508 13.5996C11.0508 20.3081 16.4894 25.7468 23.198 25.7468C26.5016 25.7468 29.4952 24.4266 31.685 22.2864L32.0572 21.9058V11.5651H30.1239Z" fill="currentColor"/>
          </svg>
        </a>
      </div>
      
      <!-- Navigation Links -->
      <div class="hidden md:flex items-center justify-end gap-6 w-full">
        <div class="flex items-center gap-6">
        <!-- Gavekortløsninger Dropdown -->
        <div class="relative group">
          <button class:list={[
            'flex items-center gap-1 transition-colors py-2',
            activeMenu === 'gavekort' ? 'text-igive-primary font-medium' : 'text-igive-text hover:text-igive-primary'
          ]}>
            Gavekortløsninger
            <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="absolute left-0 mt-2 w-64 bg-white rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
            <div class="py-2">
              <a href={getPath('/')} class:list={[
                'block px-4 py-2.5 transition-colors',
                pathname === '/'
                  ? 'bg-igive-primary/10 text-igive-primary font-medium border-l-4 border-igive-primary'
                  : 'text-gray-700 hover:bg-gray-50'
              ]}>
                Våre løsninger
              </a>
              <a href={getPath('/tjenester/digitale-gavekort-les-mer')} class:list={[
                'block px-4 py-2.5 transition-colors',
                isRouteActive('/tjenester/digitale-gavekort-les-mer')
                  ? 'bg-igive-primary/10 text-igive-primary font-medium border-l-4 border-igive-primary'
                  : 'text-gray-700 hover:bg-gray-50'
              ]}>
                Digitale gavekort (Visa)
              </a>
              <a href={getPath('/tjenester/pos-integrert-les-mer')} class:list={[
                'block px-4 py-2.5 transition-colors',
                isRouteActive('/tjenester/pos-integrert-les-mer')
                  ? 'bg-igive-primary/10 text-igive-primary font-medium border-l-4 border-igive-primary'
                  : 'text-gray-700 hover:bg-gray-50'
              ]}>
                POS-integrert gavekort
              </a>
              <a href={getPath('/tjenester/fysiske-gavekort-les-mer')} class:list={[
                'block px-4 py-2.5 transition-colors',
                isRouteActive('/tjenester/fysiske-gavekort-les-mer')
                  ? 'bg-igive-primary/10 text-igive-primary font-medium border-l-4 border-igive-primary'
                  : 'text-gray-700 hover:bg-gray-50'
              ]}>
                Fysiske gavekort
              </a>
            </div>
          </div>
        </div>


        <!-- Partnersider Dropdown -->
        <div class="relative group">
          <button class:list={[
            'flex items-center gap-1 transition-colors py-2',
            activeMenu === 'partner' ? 'text-igive-primary font-medium' : 'text-igive-text hover:text-igive-primary'
          ]}>
            Partnersider
            <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="absolute left-0 mt-2 w-64 bg-white rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
            <div class="py-2">
              <p class="px-4 py-2.5 text-gray-500 text-sm">Partnersider kommer snart</p>
            </div>
          </div>
        </div>

        <!-- Kontakt oss Dropdown -->
        <div class="relative group">
          <button class:list={[
            'flex items-center gap-1 transition-colors py-2',
            activeMenu === 'kontakt' ? 'text-igive-primary font-medium' : 'text-igive-text hover:text-igive-primary'
          ]}>
            Kontakt oss
            <svg class="w-4 h-4 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
            <div class="py-2">
              <a href={getPath('/informasjon-til-butikker')} class:list={[
                'block px-4 py-2.5 transition-colors',
                isRouteActive('/informasjon-til-butikker')
                  ? 'bg-igive-primary/10 text-igive-primary font-medium border-l-4 border-igive-primary'
                  : 'text-gray-700 hover:bg-gray-50'
              ]}>
                Informasjon om løsningene
              </a>
              <a href={getPath('/support')} class:list={[
                'block px-4 py-2.5 transition-colors',
                isRouteActive('/support')
                  ? 'bg-igive-primary/10 text-igive-primary font-medium border-l-4 border-igive-primary'
                  : 'text-gray-700 hover:bg-gray-50'
              ]}>
                Support for butikker
              </a>
              <hr class="my-2 border-gray-100">
              <button onclick="startChat()" class="block w-full text-left px-4 py-2.5 text-gray-700 hover:bg-gray-50 transition-colors">
                Start chatbot
              </button>
              <a href="mailto:post@igive.no" class="block px-4 py-2.5 text-gray-700 hover:bg-gray-50 transition-colors">
                Send e-post
              </a>
              <a href="tel:40001378" class="block px-4 py-2.5 text-gray-700 hover:bg-gray-50 transition-colors">
                Ring oss
              </a>
              <a href={getPath('/ofte-stilte-sporsmal')} class:list={[
                'block px-4 py-2.5 transition-colors',
                isRouteActive('/ofte-stilte-sporsmal')
                  ? 'bg-igive-primary/10 text-igive-primary font-medium border-l-4 border-igive-primary'
                  : 'text-gray-700 hover:bg-gray-50'
              ]}>
                Ofte stilte spørsmål
              </a>
            </div>
          </div>
        </div>
        </div>
        
        <!-- Action buttons -->
        <div class="flex items-center gap-3">
          <a href={getPath('/kjop-gavekort')} class:list={[
            'px-6 py-2.5 bg-igive-primary text-white rounded-full hover:bg-igive-primary/90 transition-all duration-200 font-medium',
            isRouteActive('/kjop-gavekort') ? 'ring-2 ring-igive-primary/50' : ''
          ]}>
            Kjøp gavekort
          </a>
          <a href={getPath('/sjekk-saldo')} class:list={[
            'px-6 py-2.5 border-2 border-gray-300 text-igive-text rounded-full hover:border-igive-primary hover:text-igive-primary transition-all duration-200 font-medium',
            isRouteActive('/sjekk-saldo') ? 'border-igive-primary text-igive-primary bg-igive-primary/5' : 'bg-white'
          ]}>
            Sjekk saldo
          </a>
        </div>
      </div>

      <!-- Mobile Menu Button -->
      <button id="mobile-menu-button" class="md:hidden">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </nav>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="md:hidden hidden mt-4 pb-4">
      <!-- Gavekortløsninger -->
      <div class="border-b border-gray-100 pb-2 mb-2">
        <button class:list={[
          'flex items-center justify-between w-full px-2 py-2 text-left font-medium',
          activeMenu === 'gavekort' ? 'text-igive-primary' : 'text-igive-text'
        ]} onclick="toggleMobileSubmenu('gavekort-submenu')">
          Gavekortløsninger
          <svg class="w-4 h-4 transition-transform" id="gavekort-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="gavekort-submenu" class="hidden pl-4 mt-2">
          <a href={getPath('/')} class:list={[
            'block py-2 transition-colors',
            pathname === '/' 
              ? 'text-igive-primary font-medium' 
              : 'text-gray-600 hover:text-igive-primary'
          ]}>
            Våre løsninger
          </a>
          <a href={getPath('/tjenester/digitale-gavekort-les-mer')} class:list={[
            'block py-2 transition-colors',
            isRouteActive('/tjenester/digitale-gavekort-les-mer') 
              ? 'text-igive-primary font-medium' 
              : 'text-gray-600 hover:text-igive-primary'
          ]}>
            Digitale gavekort (Visa)
          </a>
          <a href={getPath('/tjenester/pos-integrert-les-mer')} class:list={[
            'block py-2 transition-colors',
            isRouteActive('/tjenester/pos-integrert-les-mer') 
              ? 'text-igive-primary font-medium' 
              : 'text-gray-600 hover:text-igive-primary'
          ]}>
            POS-integrert gavekort
          </a>
          <a href={getPath('/tjenester/fysiske-gavekort-les-mer')} class:list={[
            'block py-2 transition-colors',
            isRouteActive('/tjenester/fysiske-gavekort-les-mer') 
              ? 'text-igive-primary font-medium' 
              : 'text-gray-600 hover:text-igive-primary'
          ]}>
            Fysiske gavekort
          </a>
        </div>
      </div>

      <!-- Mobile Action Buttons -->
      <div class="border-b border-gray-100 pb-4 mb-2">
        <div class="flex flex-col gap-2 px-2">
          <a href={getPath('/kjop-gavekort')} class:list={[
            'px-6 py-3 bg-igive-primary text-white rounded-full text-center font-medium transition-colors',
            isRouteActive('/kjop-gavekort') ? 'ring-2 ring-igive-primary/50' : ''
          ]}>
            Kjøp gavekort
          </a>
          <a href={getPath('/sjekk-saldo')} class:list={[
            'px-6 py-3 border-2 border-gray-300 text-igive-text rounded-full text-center font-medium transition-colors',
            isRouteActive('/sjekk-saldo') ? 'border-igive-primary text-igive-primary bg-igive-primary/5' : 'bg-white'
          ]}>
            Sjekk saldo
          </a>
        </div>
      </div>

      <!-- Partnersider -->
      <div class="border-b border-gray-100 pb-2 mb-2">
        <button class:list={[
          'flex items-center justify-between w-full px-2 py-2 text-left font-medium',
          activeMenu === 'partner' ? 'text-igive-primary' : 'text-igive-text'
        ]} onclick="toggleMobileSubmenu('partner-submenu')">
          Partnersider
          <svg class="w-4 h-4 transition-transform" id="partner-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="partner-submenu" class="hidden pl-4 mt-2">
          <p class="py-2 text-gray-500 text-sm">Partnersider kommer snart</p>
        </div>
      </div>

      <!-- Kontakt oss -->
      <div>
        <button class:list={[
          'flex items-center justify-between w-full px-2 py-2 text-left font-medium',
          activeMenu === 'kontakt' ? 'text-igive-primary' : 'text-igive-text'
        ]} onclick="toggleMobileSubmenu('kontakt-submenu')">
          Kontakt oss
          <svg class="w-4 h-4 transition-transform" id="kontakt-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <div id="kontakt-submenu" class="hidden pl-4 mt-2">
          <a href={getPath('/informasjon-til-butikker')} class:list={[
            'block py-2 transition-colors',
            isRouteActive('/informasjon-til-butikker') 
              ? 'text-igive-primary font-medium' 
              : 'text-gray-600 hover:text-igive-primary'
          ]}>
            Informasjon om løsningene
          </a>
          <a href={getPath('/support')} class:list={[
            'block py-2 transition-colors',
            isRouteActive('/support') 
              ? 'text-igive-primary font-medium' 
              : 'text-gray-600 hover:text-igive-primary'
          ]}>
            Support for butikker
          </a>
          <button onclick="startChat()" class="block py-2 text-gray-600 hover:text-igive-primary text-left w-full">
            Start chatbot
          </button>
          <a href="mailto:post@igive.no" class="block py-2 text-gray-600 hover:text-igive-primary">
            Send e-post
          </a>
          <a href="tel:40001378" class="block py-2 text-gray-600 hover:text-igive-primary">
            Ring oss
          </a>
          <a href={getPath('/ofte-stilte-sporsmal')} class:list={[
            'block py-2 transition-colors',
            isRouteActive('/ofte-stilte-sporsmal') 
              ? 'text-igive-primary font-medium' 
              : 'text-gray-600 hover:text-igive-primary'
          ]}>
            Ofte stilte spørsmål
          </a>
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  document.getElementById('mobile-menu-button')?.addEventListener('click', function() {
    const menu = document.getElementById('mobile-menu');
    menu?.classList.toggle('hidden');
  });

  function toggleMobileSubmenu(submenuId: string) {
    const submenu = document.getElementById(submenuId);
    const arrow = document.getElementById(submenuId.replace('-submenu', '-arrow'));
    
    if (submenu) {
      submenu.classList.toggle('hidden');
      arrow?.classList.toggle('rotate-180');
    }
  }

  function startChat() {
    console.log('Starting chat...');
    // Implement chat functionality here
  }

  // Attach to window for mobile menu
  (window as any).toggleMobileSubmenu = toggleMobileSubmenu;
  (window as any).startChat = startChat;
</script>